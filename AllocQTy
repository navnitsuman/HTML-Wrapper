Sub RunMacro()
    Dim iCounter As Integer
    Dim iStartRow As Integer
    Dim iEndRow As Integer
    Dim lMaxAllowedQTY As Long
    Dim lQTYSold As Long
    Dim lCumulativeQTYSold As Long
    Dim dCumulativeAmount As Double
    
    iCounter = 2
    
    Do While Range("A" & iCounter).Value <> ""
        iEndRow = Mid(Range("E" & iCounter).MergeArea.Address, InStrRev(Range("E" & iCounter).MergeArea.Address, "$") + 1)
        
        Range("F" & iCounter).Value = "=Sum(C" & iCounter & ":C" & iEndRow & ")"
        
        lQTYSold = Range("F" & iCounter).Value
        lMaxAllowedQTY = Range("E" & iCounter).Value
        
        If Range("F" & iCounter).Value > Range("E" & iCounter).Value Then
            Range("E" & iCounter).MergeArea.Interior.Color = vbRed
            
            lCumulativeQTYSold = 0
            dCumulativeAmount = 0
            For iStartRow = iEndRow To iCounter Step -1
                
                If (lCumulativeQTYSold + Range("C" & iStartRow).Value) > lMaxAllowedQTY Then
                    
                    dCumulativeAmount = dCumulativeAmount + ((lMaxAllowedQTY - lCumulativeQTYSold) * Range("B" & iStartRow).Value * Range("D" & iStartRow).Value)
                    lCumulativeQTYSold = lCumulativeQTYSold + (lMaxAllowedQTY - lCumulativeQTYSold)
                    
                Else
                    lCumulativeQTYSold = lCumulativeQTYSold + Range("C" & iStartRow).Value
                    
                    dCumulativeAmount = dCumulativeAmount + (Range("B" & iStartRow).Value * Range("C" & iStartRow).Value * Range("D" & iStartRow).Value)
                    
                End If
            Next
            Range("G" & iCounter).Value = dCumulativeAmount
            
        Else
            Range("E" & iCounter).MergeArea.Interior.Color = vbGreen
            
            Range("G" & iCounter).Value = "=SumProduct(B" & iCounter & ":B" & iEndRow & _
                                        ",C" & iCounter & ":C" & iEndRow & _
                                        ",D" & iCounter & ":D" & iEndRow & ")"
        
        End If
        iCounter = iEndRow + 1
    Loop
        
End Sub
